@model IEnumerable<DemoApp.Models.User>
@{
    ViewData["Title"] = "Quản lý người dùng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml"; // hoặc layout admin của bạn
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">

            <!-- Header + Nút thêm -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1 text-primary fw-bold">
                        <i class="fas fa-users me-3"></i> Quản lý người dùng
                    </h2>
                    <p class="text-muted mb-0">Tổng cộng: <strong>@Model.Count()</strong> tài khoản</p>
                </div>
                <a asp-action="Create" class="btn btn-lg btn-primary shadow-sm rounded-pill px-4">
                    <i class="fas fa-plus me-2"></i> Thêm người dùng mới
                </a>
            </div>

            <!-- Card bảng đẹp -->
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" style="min-width: 900px;">
                            <thead class="bg-gradient-primary text-white">
                                <tr>
                                    <th class="ps-4">#</th>
                                    <th>Họ tên</th>
                                    <th>Email</th>
                                    <th>Số điện thoại</th>
                                    <th>Vai trò</th>
                                    <th class="text-center">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null && Model.Any())
                                {
                                    int rowNum = 1;
                                    foreach (var item in Model)
                                    {
                                        var roleBadge = item.Role?.RoleName == "Admin"
                                        ? "bg-danger"
                                        : "bg-success";

                                        <tr class="border-start border-3 border-primary">
                                            <td class="ps-4 fw-bold text-primary">@rowNum</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar avatar-sm bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center">
                                                        @(string.IsNullOrEmpty(item.FullName) ? "?" : item.FullName.Substring(0, 1).ToUpper())
                                                    </div>
                                                    <div>
                                                        <div class="fw-semibold">@(item.FullName ?? "Chưa đặt tên")</div>
                                                        <small class="text-muted">@item.Username</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <a href="mailto:@item.Email" class="text-decoration-none">@item.Email</a>
                                            </td>
                                            <td>@(item.NumberPhone ?? "-")</td>
                                            <td>
                                                <span class="badge @roleBadge text-white px-3 py-2 rounded-pill">
                                                    @(item.Role?.RoleName ?? "User")
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group" role="group">
                                                    <a asp-action="Details" asp-route-id="@item.UserId"
                                                       class="btn btn-sm btn-outline-info rounded-start" title="Xem chi tiết">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a asp-action="Edit" asp-route-id="@item.UserId"
                                                       class="btn btn-sm btn-outline-warning" title="Sửa">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <a asp-action="Delete"
                                                       asp-route-id="@item.UserId"
                                                       class="btn btn-sm btn-outline-danger rounded-end"
                                                       title="Xóa">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </a>

                                                </div>
                                            </td>
                                        </tr>
                                        rowNum++;
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center py-5">
                                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">Chưa có người dùng nào.</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- Footer card -->
            <div class="mt-3 text-center text-muted small">
                <i class="fas fa-shield-alt me-1"></i>
                Mật khẩu đã được mã hóa BCrypt – không hiển thị để đảm bảo bảo mật
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@@fortawesome/fontawesome-free@6.5.1/css/all.min.css" />
    <style>
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
        }

        .avatar {
            width: 40px;
            height: 40px;
            font-weight: bold;
            font-size: 16px;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.08);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .btn-group .btn {
            border-radius: 0 !important;
        }

        .btn-group > .btn:first-child {
            border-top-left-radius: 0.375rem !important;
            border-bottom-left-radius: 0.375rem !important;
        }

        .btn-group > .btn:last-child {
            border-top-right-radius: 0.375rem !important;
            border-bottom-right-radius: 0.375rem !important;
        }

        .card {
            border-radius: 1rem;
        }
    </style>
}
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        async function confirmDelete(userId, username) {
            const result = await Swal.fire({
                title: 'Xóa người dùng?',
                html: `Bạn có chắc muốn <strong class="text-danger">xóa vĩnh viễn</strong> người dùng:<br><br>
                       <strong class="text-primary fs-5">${username}</strong>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Có, xóa luôn!',
                cancelButtonText: 'Hủy bỏ',
                reverseButtons: true,
                buttonsStyling: false,
                customClass: {
                    confirmButton: 'btn btn-danger px-4',
                    cancelButton: 'btn btn-secondary px-4'
                }
            });

            if (result.isConfirmed) {
                const form = document.createElement('form');
                form.method = 'POST';
                // SỬA DÒNG NÀY LÀ CHẠY NGON
                form.action = '@Url.Action("Delete", "Users")?id=' + userId;

                // Thêm antiforgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (token) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = '__RequestVerificationToken';
                    input.value = token;
                    form.appendChild(input);
                }

                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}